<base-dialog #baseDialog [tabs]="tabs" [activeTab]="activeTab()" (activeTabChange)="activeTab.set($event)" (closed)="onClose()">
    <div dialog-header class="header">
        <div class="header-group">
            <div class="header-icon-container">
                <img src="{{ getUnitImg(unit) }}" (error)="$event.target.src = '/images/unknown.png'" class="icon"
                    alt="{{ unit.model }} {{ unit.chassis }}" />
            </div>
            <div class="header-name-group">
                <div class="header-model allow-select">{{ unit.model }}</div>
                <div class="header-chassis allow-select">{{ unit.chassis }}</div>
            </div>
        </div>
        <div class="header-details-container">
            <div class="spanner"></div>
            <div class="header-details">
                <div class="role" *ngIf="unit.role && unit.role != 'None'"><strong>{{ unit.role }}</strong></div>
                <div class="info-slot numeric allow-select" title="Tonnage">
                    <span class="value">{{ formatThousands(unit.tons) }}</span>
                    <img src="/images/weight.svg" class="icon" alt="tons">
                </div>
            </div>
        </div>
    </div>
    <div tab-actions>
    </div>
    <div dialog-body class="dialog-body">
        <img *ngIf="fluffImageUrl()" [src]="fluffImageUrl()" class="fluff-bg-image" alt="">
        <div class="tab-content tab-general" *ngIf="activeTab() === 'General'">
            <!-- Basic Info -->
            <div class="basic-info-block allow-select">
                <div><strong>{{ unit.type }}<span *ngIf="unit.subtype != unit.type"> - {{ unit.subtype }}</span> - {{
                        unit.weightClass }}</strong></div>
                <div>
                    <span class="muted">BV: </span>
                    @if (getAdjustedBV() != null && getAdjustedBV() != unit.bv) {
                        <strong>{{ formatThousands(getAdjustedBV()!) }}</strong>
                        <span class="muted"> ({{ formatThousands(unit.bv) }})</span>
                    } @else {
                        <strong>{{ formatThousands(unit.bv) }}</strong>
                    }
                </div>
                <div><span class="muted">Tech: </span><strong>{{ unit.techBase }} | {{ unit.techRating }}</strong></div>
                <div *ngIf="unit.year"><span class="muted">Intro Year: </span><strong>{{ unit.year }}</strong> <img
                        *ngIf="getEraImg(unit)" [src]="getEraImg(unit)" class="era-icon"
                        title="{{ unit._era?.name }}" /></div>
                <div *ngIf="unit.armorType"><span class="muted">Armor Type: </span><strong>{{ unit.armorType }}</strong>
                </div>
                <div *ngIf="unit.structureType"><span class="muted">Structure Type: </span><strong>{{ unit.structureType
                        }}</strong></div>
                <div *ngIf="unit.engine"><span class="muted">Engine: </span><strong><span *ngIf="unit.engineRating">{{
                            unit.engineRating }} </span>{{ unit.engine }}</strong></div>
                <div *ngIf="unit.moveType && unit.moveType != 'None'"><span class="muted">Motive Type: </span><strong>{{
                        unit.moveType }}</strong></div>
                <div *ngIf="unit.walk"><span class="muted">Movement: </span><strong>{{ unit.walk }} / {{ unit.run
                        }}<span *ngIf="unit.run2 != unit.run"> [{{ unit.run2 }}]</span><ng-container *ngIf="unit.jump">
                            / {{ unit.jump }}</ng-container></strong></div>
                <div *ngIf="unit.c3 && unit.c3 != 'None'"><span class="muted">Network: </span><strong>{{ unit.c3
                        }}</strong></div>
                <div><span class="muted">C-Bill Cost: </span><strong>{{ formatThousands(unit.cost) }}</strong></div>
            </div>
            <div class="quirks-block" *ngIf="unit.quirks && unit.quirks.length > 0">
                <div class="quirks">
                    <div class="muted">Quirks: </div>
                    @for (quirk of unit.quirks; let i = $index; track i) {
                        <div class="quirk" [ngClass]="getQuirkClass(quirk)" [title]="getQuirkDesc(quirk)">{{ quirk }}</div>
                    }
                </div>
            </div>
            <!-- Stat Progress Bars -->
            <div class="stat-bars-columns">
                @for (spec of (unit | statBarSpecs); let i = $index; track i) {
                    <div class="stat-bar-row">
                        <div class="stat-bar">
                            <div class="stat-bar-fill" [style.width.%]="spec.percent"></div>
                        </div>
                        <span class="stat-label">{{ spec.label }}</span>
                        <span class="stat-value">{{ spec.valueText ?? spec.value }}</span>
                    </div>
                }
            </div>

            <!-- Weapon Type Summary Bar -->
            <div class="type-summary-bar">
                <!-- First block: first 3 weapon types -->
                <div class="type-summary-block">
                    @for (type of weaponTypes.slice(0, 3); let i = $index; track i) {
                        <div class="type-summary-rect" [ngStyle]="{'border-color': type.color}" [title]="type.name">
                            <div [ngStyle]="{'background-color': type.color}" class="icon">
                                <img class="type-icon" [src]="getTypeIcon(type.code)" />
                            </div>
                            <div class="type-count">{{ getTypeCount(type.code) }}</div>
                        </div>
                    }
                </div>
                <!-- Second block: last 3 weapon types -->
                <div class="type-summary-block">
                    @for (type of weaponTypes.slice(3); let i = $index; track i) {
                        <div class="type-summary-rect" [ngStyle]="{'border-color': type.color}" [title]="type.name">
                            <div [ngStyle]="{'background-color': type.color}" class="icon">
                                <img class="type-icon" [src]="getTypeIcon(type.code)" />
                            </div>
                            <div class="type-count">{{ getTypeCount(type.code) }}</div>
                        </div>
                    }
                </div>
            </div>

            <!-- Components Grid -->
            <!-- Matrix layout (3x3) when supported and defined for unit.type -->
            <ng-container *ngIf="useMatrixLayout(); else defaultComponentsBlock">
                <div class="components-matrix" [style.grid-template-areas]="gridAreas">
                    @for (area of matrixAreaCodes; let i = $index; track i) {
                        <div class="component-rect" [style.grid-area]="area">
                            <div class="comp-loc" *ngIf="areaHasContent(area)">{{ getAreaLabel(area) }}</div>
                            <div class="comp-list">
                                <!-- Bays (matrix) -->
                                @if (areaHasBays(area)) {
                                    <div class="bay">
                                        @for (bay of getBaysForArea(area); let i = $index; track trackByBay(bay)) {
                                            <div class="subcomponent-data {{ getTypeClass(bay.t) }}"
                                                (mouseenter)="onCompMouseEnter(bay, $event)" (mouseleave)="onCompMouseLeave()">
                                                <div class="comp-title">
                                                    <span class="comp-qty">{{ bay.q }}×</span>
                                                    <span class="comp-name">{{ bay.n }}<span *ngIf="bay.q2" class="ammo-count"> ({{ bay.q2 }})</span></span>
                                                </div>
                                            </div>
                                        }
                                    </div>
                                } @else {
                                    <!-- Normal components (matrix) -->
                                    @for (comp of getComponentsForArea(area); let i = $index; track trackByComp(comp)) {
                                    <div class="component-data {{ getTypeClass(comp.t) }}"
                                        (mouseenter)="onCompMouseEnter(comp, $event)" (mouseleave)="onCompMouseLeave()">
                                        <div class="comp-title">
                                            <span class="comp-qty">{{ comp.q }}×</span>
                                            <span class="comp-name">{{ comp.n }}<span *ngIf="comp.q2" class="ammo-count"> ({{ comp.q2 }})</span></span>
                                            <span *ngIf="unit.techBase == 'Mixed' && comp.eq && comp.eq.base != 'All'"
                                                class="tech-base"><img src="/images/component-{{ comp.eq.base == 'IS' ? 'is' : 'clan' }}.svg" alt="{{ comp.eq.base == 'IS' ? 'IS' : 'Clan' }}" />
                                            </span>
                                        </div>
                                    </div>
                                    }
                                }
                            </div>
                        </div>
                    }
                </div>
            </ng-container>

            <!-- Default -->
            <ng-template #defaultComponentsBlock>
                <div class="components-container" *ngIf="hasBays(); else normalComponents">
                    @for (group of groupedBays; let i = $index; track group.l) {
                        <div class="component-rect">
                            <div class="comp-loc">{{ group.l }}</div>
                            <div class="bay">
                                @for (bay of group.bays; let j = $index; track j) {
                                    <div class="subcomponent-data {{ getTypeClass(bay.t) }}"
                                        (mouseenter)="onCompMouseEnter(bay, $event)" (mouseleave)="onCompMouseLeave()">
                                        <div class="comp-title">
                                            <span class="comp-qty">{{ bay.q }}×</span>
                                            <span class="comp-name">{{ bay.n }}<span *ngIf="bay.q2" class="ammo-count"> ({{ bay.q2 }})</span></span>
                                        </div>
                                    </div>
                                }
                            </div>
                        </div>
                    }
                </div>
                <ng-template #normalComponents>
                    <div class="components-container">
                        @for (comp of components; let i = $index; track i) {
                            <div class="component-rect">
                                <div class="comp-loc">{{ comp.l }}</div>
                                <div class="component-data {{ getTypeClass(comp.t) }}"
                                    (mouseenter)="onCompMouseEnter(comp, $event)" (mouseleave)="onCompMouseLeave()">
                                    <div class="comp-title">
                                        <span class="comp-qty">{{ comp.q }}×</span>
                                        <span class="comp-name">{{ comp.n }}<span *ngIf="comp.q2" class="ammo-count"> ({{ comp.q2 }})</span></span>
                                        <span *ngIf="unit.techBase == 'Mixed' && comp.eq && comp.eq.base != 'All'"
                                            class="tech-base"><img src="/images/component-{{ comp.eq.base == 'IS' ? 'is' : 'clan' }}.svg" alt="{{ comp.eq.base == 'IS' ? 'IS' : 'Clan' }}" />
                                        </span>
                                    </div>
                                </div>
                            </div>
                        }
                    </div>
                </ng-template>
                <ng-container *ngIf="unit.comp | filterAmmo as ammoList">
                    <ng-container *ngIf="ammoList.length > 0">
                        <div class="ammo-list"><span class="info-label muted">Ammo: </span>
                            @for (comp of ammoList; let last = $last; let i = $index; track i) {
                                <span class="ammo-pill" (mouseenter)="onCompMouseEnter(comp, $event)"
                                    (mouseleave)="onCompMouseLeave()">({{ comp.n }}) {{ comp.q2 }}</span>@if(!last){, }
                            }
                        </div>
                    </ng-container>
                </ng-container>
            </ng-template>

            <div class="spanner"></div>

            <div class="bottom-info">
                <div class="bottom-left" *ngIf="unit.source"><span class="label muted">Source: </span><strong>{{
                        unit.source }}</strong></div>
                <div class="bottom-right" *ngIf="unit.id && unit.id > 0"><span class="label muted">MUL ID: </span><a
                        class="mul-link" target=_BLANK href="http://masterunitlist.info/Unit/Details/{{unit.id}}">{{
                        unit.id }}</a></div>
            </div>
        </div>

        <!-- Factions -->
        <div class="tab-content" *ngIf="activeTab() === 'Factions'">
            <div class="faction-availability-list allow-select">
                @if (factionAvailability.length === 0) {
                    <div class="no-factions">No faction availability information for this unit.</div>
                } @else {
                    @for (era of factionAvailability; let i = $index; track i) {
                        <div class="era-name">
                            <img [src]="era.eraImg" class="era-icon" *ngIf="era.eraImg" />
                            <strong>{{ era.eraName }}:</strong>
                        </div>
                        <div class="faction-list">
                            @for (faction of era.factions; let isLast = $last; track faction.name) {
                                <span>{{ faction.name }}{{ !isLast ? ', ' : '' }}</span>
                            }
                        </div>
                    }
                }
            </div>
        </div>

        <!-- Intel -->
        <div class="tab-content" *ngIf="activeTab() === 'Intel'">
            <div class="fluff-content allow-select">
                <ng-container *ngIf="unit.fluff; else noFluff">
                    <!-- Fluff Image -->
                    <div class="fluff-image-container" *ngIf="fluffImageUrl()">
                        <img [src]="fluffImageUrl()" class="fluff-image" (error)="onFluffImageError()"
                            alt="{{ unit.model }} {{ unit.chassis }}" />
                    </div>

                    <div class="fluff-section" *ngIf="unit.fluff.manufacturer">
                        <div class="fluff-label">Manufacturers:</div>
                        <div class="fluff-text">{{ sanitizeFluffHtml(unit.fluff.manufacturer) }}</div>
                    </div>

                    <div class="fluff-section" *ngIf="unit.fluff.primaryFactory">
                        <div class="fluff-label">Primary Factories:</div>
                        <div class="fluff-text">{{ sanitizeFluffHtml(unit.fluff.primaryFactory) }}</div>
                    </div>

                    <div class="fluff-section" *ngIf="unit.fluff.capabilities">
                        <div class="fluff-label">Capabilities:</div>
                        <div class="fluff-text">{{ sanitizeFluffHtml(unit.fluff.capabilities) }}</div>
                    </div>

                    <div class="fluff-section" *ngIf="unit.fluff.overview">
                        <div class="fluff-label">Overview:</div>
                        <div class="fluff-text">{{ sanitizeFluffHtml(unit.fluff.overview) }}</div>
                    </div>

                    <div class="fluff-section" *ngIf="unit.fluff.deployment">
                        <div class="fluff-label">Deployment:</div>
                        <div class="fluff-text">{{ sanitizeFluffHtml(unit.fluff.deployment) }}</div>
                    </div>

                    <div class="fluff-section" *ngIf="unit.fluff.history">
                        <div class="fluff-label">History:</div>
                        <div class="fluff-text">{{ sanitizeFluffHtml(unit.fluff.history) }}</div>
                    </div>

                    <div class="fluff-section" *ngIf="unit.fluff.notes">
                        <div class="fluff-label">Notes:</div>
                        <div class="fluff-text">{{ sanitizeFluffHtml(unit.fluff.notes) }}</div>
                    </div>
                </ng-container>

                <ng-template #noFluff>
                    <div class="no-fluff">
                        No intel available for this unit.
                    </div>
                </ng-template>
            </div>
        </div>
    </div>
    <div class="footer" dialog-footer>
        <button class="modal-btn bt-button" (click)="onAdd()">ADD</button>
        <button class="modal-btn bt-button" (click)="onShare()">SHARE</button>
        <button class="modal-btn bt-button" (click)="onClose()">CLOSE</button>
    </div>
</base-dialog>
<button *ngIf="hasPrev" class="nav-arrow nav-arrow-left" (click)="onPrev()" aria-label="Previous Unit">
    &#10094;
</button>
<button *ngIf="hasNext" class="nav-arrow nav-arrow-right" (click)="onNext()" aria-label="Next Unit">
    &#10095;
</button>
<floating-comp-info [unit]="unit" [comp]="hoveredComp()" [hoverRect]="hoverRect()" (mouseenter)="onFloatingMouseEnter()"
    (mouseleave)="onFloatingMouseLeave()">
</floating-comp-info>